{
  "openapi": "3.0.0",
  "info": {
    "title": "Authorization & Permissions API",
    "version": "1.0.0",
    "description": "API endpoints for role-based access control and permissions management"
  },
  "paths": {
    "/api/v1/auth/permissions": {
      "get": {
        "tags": ["Authorization"],
        "summary": "Get current user permissions",
        "description": "Returns permissions and role information for the authenticated user",
        "security": [{"bearerAuth": []}],
        "responses": {
          "200": {
            "description": "User permissions retrieved successfully",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/PermissionsResponse"
                }
              }
            }
          },
          "401": {
            "description": "Unauthorized - invalid or expired token"
          },
          "403": {
            "description": "Forbidden - insufficient permissions"
          }
        }
      }
    },
    "/api/v1/auth/permissions/validate": {
      "post": {
        "tags": ["Authorization"],
        "summary": "Validate specific permission",
        "description": "Check if current user has specific permission",
        "security": [{"bearerAuth": []}],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/PermissionValidationRequest"
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Permission validation result",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/PermissionValidationResponse"
                }
              }
            }
          }
        }
      }
    },
    "/api/v1/admin/roles": {
      "get": {
        "tags": ["Admin - Roles"],
        "summary": "List all available roles",
        "description": "Get list of all roles in the system (admin only)",
        "security": [{"bearerAuth": []}],
        "responses": {
          "200": {
            "description": "Roles retrieved successfully",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/RolesListResponse"
                }
              }
            }
          },
          "403": {
            "description": "Forbidden - admin access required"
          }
        }
      },
      "post": {
        "tags": ["Admin - Roles"],
        "summary": "Create new role",
        "description": "Create a new custom role (admin only)",
        "security": [{"bearerAuth": []}],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/CreateRoleRequest"
              }
            }
          }
        },
        "responses": {
          "201": {
            "description": "Role created successfully",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/RoleResponse"
                }
              }
            }
          }
        }
      }
    },
    "/api/v1/admin/users/{userId}/role": {
      "put": {
        "tags": ["Admin - User Management"],
        "summary": "Update user role",
        "description": "Change role assignment for a user",
        "security": [{"bearerAuth": []}],
        "parameters": [
          {
            "name": "userId",
            "in": "path",
            "required": true,
            "schema": {
              "type": "string",
              "format": "uuid"
            }
          }
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/UpdateUserRoleRequest"
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "User role updated successfully",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/UserRoleUpdateResponse"
                }
              }
            }
          },
          "403": {
            "description": "Forbidden - insufficient permissions to assign this role"
          },
          "404": {
            "description": "User not found"
          }
        }
      }
    },
    "/api/v1/admin/audit-logs": {
      "get": {
        "tags": ["Admin - Audit"],
        "summary": "Get audit logs",
        "description": "Retrieve access audit logs (admin only)",
        "security": [{"bearerAuth": []}],
        "parameters": [
          {
            "name": "X-Device-Id",
            "in": "header",
            "required": true,
            "description": "Device ID for session validation",
            "schema": {
              "type": "string",
              "format": "uuid"
            }
          },
          {
            "name": "page",
            "in": "query",
            "schema": {
              "type": "integer",
              "default": 1
            }
          },
          {
            "name": "limit",
            "in": "query",
            "schema": {
              "type": "integer",
              "default": 20,
              "maximum": 100
            }
          },
          {
            "name": "action",
            "in": "query",
            "schema": {
              "type": "string",
              "enum": ["access_denied", "permission_granted", "role_changed", "login", "logout", "permission_denied", "role_escalation"]
            }
          },
          {
            "name": "userId",
            "in": "query",
            "schema": {
              "type": "string",
              "format": "uuid"
            }
          },
          {
            "name": "sessionId",
            "in": "query",
            "schema": {
              "type": "string",
              "format": "uuid"
            }
          },
          {
            "name": "from",
            "in": "query",
            "schema": {
              "type": "string",
              "format": "date-time"
            }
          },
          {
            "name": "to",
            "in": "query",
            "schema": {
              "type": "string",
              "format": "date-time"
            }
          }
        ],
        "responses": {
          "200": {
            "description": "Audit logs retrieved successfully",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/AuditLogsResponse"
                }
              }
            }
          }
        }
      },
      "post": {
        "tags": ["Admin - Audit"],
        "summary": "Create audit log entry",
        "description": "Log access attempt or security event",
        "security": [{"bearerAuth": []}],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/CreateAuditLogRequest"
              }
            }
          }
        },
        "responses": {
          "201": {
            "description": "Audit log created successfully"
          }
        }
      }
    },
    "/api/v1/admin/sessions": {
      "get": {
        "tags": ["Admin - Session Management"],
        "summary": "List company sessions",
        "description": "Get all sessions for the company (admin/manager only)",
        "security": [{"bearerAuth": []}],
        "parameters": [
          {
            "name": "X-Device-Id",
            "in": "header",
            "required": true,
            "description": "Device ID for session validation",
            "schema": {
              "type": "string",
              "format": "uuid"
            }
          },
          {
            "name": "status",
            "in": "query",
            "description": "Filter by session status",
            "schema": {
              "type": "string",
              "enum": ["active", "expired", "revoked", "suspicious"]
            }
          },
          {
            "name": "userId",
            "in": "query",
            "schema": {
              "type": "string",
              "format": "uuid"
            }
          },
          {
            "name": "clientType",
            "in": "query",
            "schema": {
              "type": "string",
              "enum": ["web", "extension"]
            }
          }
        ],
        "responses": {
          "200": {
            "description": "Sessions retrieved successfully",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/CompanySessionsResponse"
                }
              }
            }
          }
        }
      }
    },
    "/api/v1/admin/sessions/{sessionId}/terminate": {
      "post": {
        "tags": ["Admin - Session Management"],
        "summary": "Force terminate session",
        "description": "Force terminate a specific session (admin/manager only)",
        "security": [{"bearerAuth": []}],
        "parameters": [
          {
            "name": "sessionId",
            "in": "path",
            "required": true,
            "schema": {
              "type": "string",
              "format": "uuid"
            }
          },
          {
            "name": "X-Device-Id",
            "in": "header",
            "required": true,
            "description": "Device ID for session validation",
            "schema": {
              "type": "string",
              "format": "uuid"
            }
          }
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/TerminateSessionRequest"
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Session terminated successfully"
          }
        }
      }
    }
  },
  "components": {
    "securitySchemes": {
      "bearerAuth": {
        "type": "http",
        "scheme": "bearer",
        "bearerFormat": "JWT"
      }
    },
    "schemas": {
      "PermissionsResponse": {
        "type": "object",
        "properties": {
          "success": {
            "type": "boolean",
            "example": true
          },
          "data": {
            "type": "object",
            "properties": {
              "user": {
                "$ref": "#/components/schemas/User"
              },
              "role": {
                "$ref": "#/components/schemas/Role"
              },
              "permissions": {
                "$ref": "#/components/schemas/ComputedPermissions"
              },
              "organization": {
                "$ref": "#/components/schemas/Organization"
              }
            }
          },
          "cached": {
            "type": "boolean",
            "description": "Whether response came from cache"
          },
          "expiresIn": {
            "type": "integer",
            "description": "Seconds until cache expires"
          }
        }
      },
      "PermissionValidationRequest": {
        "type": "object",
        "required": ["permission"],
        "properties": {
          "permission": {
            "type": "string",
            "description": "Permission to validate (e.g., 'leads.create', 'users.manage')",
            "example": "leads.create"
          },
          "resource": {
            "type": "string",
            "description": "Optional resource ID for context-specific validation"
          }
        }
      },
      "PermissionValidationResponse": {
        "type": "object",
        "properties": {
          "success": {
            "type": "boolean"
          },
          "data": {
            "type": "object",
            "properties": {
              "hasPermission": {
                "type": "boolean"
              },
              "permission": {
                "type": "string"
              },
              "reason": {
                "type": "string",
                "description": "Explanation if permission denied"
              }
            }
          }
        }
      },
      "Role": {
        "type": "object",
        "properties": {
          "id": {
            "type": "string",
            "format": "uuid"
          },
          "nome": {
            "type": "string",
            "example": "empresa_admin"
          },
          "descricao": {
            "type": "string",
            "example": "Administrador da empresa"
          },
          "permissoes": {
            "$ref": "#/components/schemas/PermissionSet"
          },
          "created_at": {
            "type": "string",
            "format": "date-time"
          }
        }
      },
      "PermissionSet": {
        "type": "object",
        "properties": {
          "all": {
            "type": "boolean",
            "description": "Full system access (admin only)"
          },
          "leads": {
            "type": "string",
            "enum": ["all", "read", "api"],
            "description": "Lead management permissions"
          },
          "usuarios": {
            "type": "string",
            "enum": ["manage", "read"],
            "description": "User management permissions"
          },
          "campanhas": {
            "type": "string",
            "enum": ["all", "read"],
            "description": "Campaign management permissions"
          },
          "webhooks": {
            "type": "string",
            "enum": ["receive"],
            "description": "Webhook permissions"
          },
          "admin": {
            "type": "string",
            "enum": ["all"],
            "description": "Administrative functions"
          },
          "dashboard": {
            "type": "string",
            "enum": ["all", "read"],
            "description": "Dashboard access"
          },
          "search_terms": {
            "type": "string",
            "enum": ["all", "read"],
            "description": "Search terms management"
          }
        }
      },
      "ComputedPermissions": {
        "type": "object",
        "properties": {
          "canCreateUsers": {"type": "boolean"},
          "canEditUsers": {"type": "boolean"},
          "canDeleteUsers": {"type": "boolean"},
          "canViewAllLeads": {"type": "boolean"},
          "canCreateLeads": {"type": "boolean"},
          "canEditLeads": {"type": "boolean"},
          "canDeleteLeads": {"type": "boolean"},
          "canManageCampaigns": {"type": "boolean"},
          "canViewReports": {"type": "boolean"},
          "canAccessAdmin": {"type": "boolean"},
          "scopeToOrganization": {"type": "boolean"}
        }
      },
      "User": {
        "type": "object",
        "properties": {
          "id": {"type": "string", "format": "uuid"},
          "email": {"type": "string", "format": "email"},
          "nome": {"type": "string"},
          "telefone": {"type": "string"},
          "ativo": {"type": "boolean"},
          "role": {"type": "string"},
          "empresa_id": {"type": "string", "format": "uuid"},
          "created_at": {"type": "string", "format": "date-time"},
          "updated_at": {"type": "string", "format": "date-time"}
        }
      },
      "Organization": {
        "type": "object",
        "properties": {
          "id": {"type": "string", "format": "uuid"},
          "nome": {"type": "string"},
          "cnpj": {"type": "string"},
          "email": {"type": "string", "format": "email"},
          "saldo_creditos": {"type": "number"},
          "api_key": {"type": "string"}
        }
      },
      "RolesListResponse": {
        "type": "object",
        "properties": {
          "success": {"type": "boolean"},
          "data": {
            "type": "array",
            "items": {"$ref": "#/components/schemas/Role"}
          }
        }
      },
      "CreateRoleRequest": {
        "type": "object",
        "required": ["nome", "descricao", "permissoes"],
        "properties": {
          "nome": {"type": "string"},
          "descricao": {"type": "string"},
          "permissoes": {"$ref": "#/components/schemas/PermissionSet"}
        }
      },
      "RoleResponse": {
        "type": "object",
        "properties": {
          "success": {"type": "boolean"},
          "data": {"$ref": "#/components/schemas/Role"}
        }
      },
      "UpdateUserRoleRequest": {
        "type": "object",
        "required": ["role"],
        "properties": {
          "role": {
            "type": "string",
            "description": "New role name"
          },
          "reason": {
            "type": "string",
            "description": "Reason for role change (for audit)"
          }
        }
      },
      "UserRoleUpdateResponse": {
        "type": "object",
        "properties": {
          "success": {"type": "boolean"},
          "data": {
            "type": "object",
            "properties": {
              "user": {"$ref": "#/components/schemas/User"},
              "previousRole": {"type": "string"},
              "newRole": {"type": "string"},
              "updatedAt": {"type": "string", "format": "date-time"}
            }
          }
        }
      },
      "AuditLog": {
        "type": "object",
        "properties": {
          "id": {"type": "string", "format": "uuid"},
          "user_id": {"type": "string", "format": "uuid"},
          "action": {"type": "string"},
          "resource": {"type": "string"},
          "resource_id": {"type": "string", "format": "uuid"},
          "details": {"type": "object"},
          "ip_address": {"type": "string"},
          "user_agent": {"type": "string"},
          "timestamp": {"type": "string", "format": "date-time"}
        }
      },
      "AuditLogsResponse": {
        "type": "object",
        "properties": {
          "success": {"type": "boolean"},
          "data": {
            "type": "object",
            "properties": {
              "logs": {
                "type": "array",
                "items": {"$ref": "#/components/schemas/AuditLog"}
              },
              "pagination": {
                "type": "object",
                "properties": {
                  "page": {"type": "integer"},
                  "limit": {"type": "integer"},
                  "total": {"type": "integer"},
                  "totalPages": {"type": "integer"}
                }
              }
            }
          }
        }
      },
      "CreateAuditLogRequest": {
        "type": "object",
        "required": ["action", "resource"],
        "properties": {
          "action": {
            "type": "string",
            "enum": ["access_denied", "permission_granted", "role_changed", "login", "logout", "permission_denied", "role_escalation"]
          },
          "resource": {"type": "string"},
          "resource_id": {"type": "string"},
          "session_id": {"type": "string", "format": "uuid"},
          "details": {"type": "object"},
          "ip_address": {"type": "string"},
          "user_agent": {"type": "string"}
        }
      },
      "CompanySessionsResponse": {
        "type": "object",
        "properties": {
          "success": {"type": "boolean"},
          "data": {
            "type": "object",
            "properties": {
              "sessions": {
                "type": "array",
                "items": {
                  "$ref": "#/components/schemas/SessionInfo"
                }
              },
              "total": {"type": "integer"},
              "active_sessions": {"type": "integer"},
              "session_limit": {"type": "integer"},
              "current_usage_percentage": {"type": "number"}
            }
          }
        }
      },
      "SessionInfo": {
        "type": "object",
        "properties": {
          "session_id": {"type": "string", "format": "uuid"},
          "user_id": {"type": "string", "format": "uuid"},
          "user_name": {"type": "string"},
          "user_email": {"type": "string", "format": "email"},
          "device_id": {"type": "string", "format": "uuid"},
          "client_type": {
            "type": "string",
            "enum": ["web", "extension"]
          },
          "status": {
            "type": "string",
            "enum": ["active", "expired", "revoked", "suspicious"]
          },
          "ip_address": {"type": "string"},
          "user_agent": {"type": "string"},
          "created_at": {"type": "string", "format": "date-time"},
          "last_activity_at": {"type": "string", "format": "date-time"},
          "expires_at": {"type": "string", "format": "date-time"},
          "is_current_session": {"type": "boolean"}
        }
      },
      "TerminateSessionRequest": {
        "type": "object",
        "required": ["reason"],
        "properties": {
          "reason": {
            "type": "string",
            "description": "Reason for terminating the session"
          },
          "notify_user": {
            "type": "boolean",
            "default": true,
            "description": "Whether to notify the user about session termination"
          }
        }
      }
    }
  }
}